---
title: "Customizing a publication list with R Markdown"
description: "*May 19th, 2022* - Notes on creating a customizable list of publications for an academic website using R markdown, .bib files, and other fun stuff."
author: "Matt Crump"
date: '2022-05-17 `r paste("Last knit: ", lubridate::today())`'
bibliography: Crump.bib
opengraph:
  image:
    src: "https://www.crumplab.com/articles/blog/post_997_5_19_22_pubs/imgs/publications_list.jpg"
  twitter:
    card: summary_large_image
    creator: "@MattCrumpLab"
    site: "@MattCrumpLab"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using R Markdown to list publications on website}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

<img src="imgs/publications_list.jpg" style= width="100%"/>

I've been using R Markdown to generate my lab website for years. I recently switched from the [generic R markdown website](https://rmarkdown.rstudio.com/lesson-13.html) to a website generated by [pkgdown](https://pkgdown.r-lib.org). I'm happy with the result. As a part of the migration I'm revisiting individual pages like my [publications](https://www.crumplab.com/articles/Publications.html) page.

Over the years I've tried different ways to list publications. I like any process that takes a `.bib` file containing my publications, and then auto-generates everything I want to have.

## bibbase

I was previously using [bibbase](https://bibbase.org), which takes a `.bib` file as input and embeds a list of publications into a webpage. For example, I used to generate a publication list by inserting a script into the `.Rmd` for my publications page.


```
 <script src="https://bibbase.org/show?bib=https://crumplab.github.io/Crump.bib&jsonp=1&nocache=1&theme=side&authorFirst=1"></script>
```

It was quick, easy, and pretty good overall.

## bibbase issues

But, there were nuisances. I couldn't get the formatting exactly right.  I don't think bibbase supports different `.csl` formats, so it doesn't display citations in APA format.

Bibbase recognizes extra tags in the `.bib` file to define arbitrary links, and then have the links printed to each citation. For example, a citation might have a pdf, a website, and data associated with it. That was nice.

However, the links double-clicked themselves. I'm not sure why this happened to me, but clicking a link to download a `.pdf` would cause the file to be downloaded twice. That was annoying.

## What I wanted

Here is the workflow that I wanted to achieve:

1. Maintain my list of publications in a zotero folder. Then, export the folder as a biblatex repository (with .pdfs).
2. Have an `.Rmd` file that reads in the `.bib` file, and then outputs the list of publications
3. The list ideally could be formatted by any `.csl` file, which would make it easy to output in APA format
4. The list should automatically add any extra links and stuff that I want (provided those things can be extracted from the `.bib` file).

## R Markdown issues and solutions

R Markdown is generally great for citing things. For example, I could cite a paper [@vuorreSharingOrganizingResearch2021], the citation would appear in the text, and a full citation would be printed in a reference section at the end of the document.

However, it's not so easy to print a full citation in the middle of an R Markdown document, in a style that you want defined by `.csl`, and with additional stuff you might want like extra links.

At least, I couldn't find a way to do that until this morning, when I came across a life-saver function from [stevemisc](http://svmiller.com/stevemisc/) called `print_refs()`.

There's at least a handful of ways to input a `.bib` file into R, and then print out a single entry. For example, `RefManageR` can do something like this, but it doesn't support `.csl`, so the output may not be in the style you want (and it doesn't output to APA).

Here's a quick example of `print_refs()` in action.

```{r}
library(bib2df)
library(stevemisc)
library(stringi)

# load a bib file to data frame
bib_df <- bib2df(file="Crump.bib")

# clean entries
bib_df$TITLE <- stri_replace_all_regex(bib_df$TITLE, "[\\{\\}]", "")
bib_df$JOURNAL <- stri_replace_all_regex(bib_df$JOURNAL, "[\\{\\}]", "")
bib_df$BOOKTITLE <- stri_replace_all_regex(bib_df$BOOKTITLE, "[\\{\\}]", "")

# convert a single row back to .bib entry
bib_entry <- paste0(capture.output(df2bib(bib_df[1,])), collapse="")
bib_entry

# print out the citation
stevemisc::print_refs(bib_entry,
                      csl = "apa.csl",
                      spit_out = TRUE,
                      delete_after = FALSE)
```

I'm so glad this function exists. It turns the `.bib` file into markdown that can be printed directly inside an `.Rmd`. And, this can be done programmatically using knitr chunks. For example, using `results=asis` in the `knitr` chunk options allows the citation to printed to the `.Rmd` document.

````{verbatim}
```{r, results="asis", echo=FALSE}
  print_me <- paste0(stevemisc::print_refs(bib_entry,csl = "apa.csl",
                                        spit_out = FALSE,
                                        delete_after = FALSE), collapse=" ")
  cat(print_me)
```
````

And, this means the citation should show up nicely on the webpage, like this:

```{r, results="asis", echo=FALSE}
  print_me <- paste0(stevemisc::print_refs(bib_entry,csl = "apa.csl",
                                        spit_out = FALSE,
                                        delete_after = FALSE), collapse=" ")
  cat(print_me)
```


## Adding links to the citation

A next step was to add any other links to a given citation. I add extra tags to a `.bib` file in the extra field for citations in zotero. For example, this line is in the extra field for the @vuorreSharingOrganizingResearch2021 paper.

```
tex.url_website: https://crumplab.github.io/vertical/
```

As a result, when the `.bib` file is loaded into R as a data.frame, it will contain a column called `URL_WEBSITE`. I can then retrieve that info and write some custom code to smash together the markdown for a citation, along with any html I want to add it. The script below auto-generates a list of the first five publications in the `.bib` file (after sorting by year, so the most recent are first).

```{r, results="asis"}

# sort bib_df by year
bib_df <- bib_df[order(bib_df$DATE, decreasing=T),]

# print individual entries to page

for (i in 1:5 ){
  t_bib_entry <- paste0(capture.output(df2bib(bib_df[i,])), collapse="")
  t_md_citation<- paste0(stevemisc::print_refs(t_bib_entry,csl = "apa.csl",
                                        spit_out = FALSE,
                                        delete_after = FALSE), collapse=" ")
  cat(t_md_citation)



  cat("<span class = 'publinks'>")

  if(any(names(bib_df)=="FILE")){
    if( !is.na(bib_df[i,"FILE"]) ){
      pdf_url <- paste0("../Crump/",bib_df[i,"FILE"], collapse = "")
      cat(c("  ",'<a href="',pdf_url,'"> <i class="fas fa-file-pdf"> pdf </i></a>'),
        sep="")
    }
  }

  if(any(names(bib_df)=="URL_WEBSITE")){
    if( !is.na(bib_df[i,"URL_WEBSITE"]) ){
      pdf_url <- as.character(bib_df[i,"URL_WEBSITE"])
      cat(c("  ",'<a href="',pdf_url,'"> <i class="fas fa-globe"> website </i></a>'),
        sep="")
    }
  }

  if(any(names(bib_df)=="URL_DATA")){
  if( !is.na(bib_df[i,"URL_DATA"]) ){
      pdf_url <- as.character(bib_df[i,"URL_DATA"])
      cat(c("  ",'<a href="',pdf_url,'"> <i class="fas fa-database"> data </i></a>'),
        sep="")
    }
  }

  cat("</span>")
  cat("\n\n")
}
```

## That's all

I now have a working pipeline that inputs a `.bib` file, and outputs a list of [publications](https://www.crumplab.com/articles/Publications.html) in APA format, with a few customizable bells and whistles.

I would feel like this excursion was wrapped up if I refactored the script into a set of functions. But, I'll leave that for another day.

<iframe src="https://giphy.com/embed/HGX3gYWt9vLZ6" width="480" height="427" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/babe-pig-james-cromwell-HGX3gYWt9vLZ6">via GIPHY</a></p>

## References
