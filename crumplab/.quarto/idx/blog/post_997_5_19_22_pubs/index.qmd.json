{"title":"Customizing a publication list with R Markdown","markdown":{"yaml":{"title":"Customizing a publication list with R Markdown","description":"Notes on creating a customizable list of publications for an academic website using R markdown, .bib files, and other fun stuff.","author":"Matt Crump","date":"2022-05-17","bibliography":"Crump.bib","image":"imgs/publications_list.jpg","opengraph":{"image":{"src":"https://www.crumplab.com/articles/blog/post_997_5_19_22_pubs/imgs/publications_list.jpg"},"twitter":{"card":"summary_large_image","creator":"@MattCrumpLab","site":"@MattCrumpLab"}}},"headingText":"| echo: FALSE","containsRefs":false,"markdown":"\n\n```{r, include = FALSE}\nknitr::opts_chunk$set(\n  collapse = TRUE,\n  comment = \"#>\",\n  message = FALSE,\n  warning = FALSE\n)\n```\n\n\n```{css, results='asis', echo=F}\n@media (min-width: 1400px) {\n    body {\n        font-size:18px\n    }\n\n    .col-md-3 {\n        margin-left: 5rem\n    }\n    \n    .row {\n        --bs-gutter-x: -20%!important;\n    }\n    \n    .row>main {\n        max-width: 40rem;\n    }\n\n}\n\n```\n\n\n```{r}\n#| out.width: 100%\nknitr::include_graphics('imgs/publications_list.jpg')\n```\n\nI've been using R Markdown to generate my lab website for years. I recently switched from the [generic R markdown website](https://rmarkdown.rstudio.com/lesson-13.html) to a website generated by [pkgdown](https://pkgdown.r-lib.org). I'm happy with the result. As a part of the migration I'm revisiting individual pages like my [publications](https://www.crumplab.com/articles/Publications.html) page.\n\nOver the years I've tried different ways to list publications. I like any process that takes a `.bib` file containing my publications, and then auto-generates everything I want to have.\n\n## bibbase\n\nI was previously using [bibbase](https://bibbase.org), which takes a `.bib` file as input and embeds a list of publications into a webpage. For example, I used to generate a publication list by inserting a script into the `.Rmd` for my publications page.\n\n\n```\n <script src=\"https://bibbase.org/show?bib=https://crumplab.github.io/Crump.bib&jsonp=1&nocache=1&theme=side&authorFirst=1\"></script>\n```\n\nIt was quick, easy, and pretty good overall.\n\n## bibbase issues\n\nBut, there were nuisances. I couldn't get the formatting exactly right.  I don't think bibbase supports different `.csl` formats, so it doesn't display citations in APA format.\n\nBibbase recognizes extra tags in the `.bib` file to define arbitrary links, and then have the links printed to each citation. For example, a citation might have a pdf, a website, and data associated with it. That was nice.\n\nHowever, the links double-clicked themselves. I'm not sure why this happened to me, but clicking a link to download a `.pdf` would cause the file to be downloaded twice. That was annoying.\n\n## What I wanted\n\nHere is the workflow that I wanted to achieve:\n\n1. Maintain my list of publications in a zotero folder. Then, export the folder as a biblatex repository (with .pdfs).\n2. Have an `.Rmd` file that reads in the `.bib` file, and then outputs the list of publications\n3. The list ideally could be formatted by any `.csl` file, which would make it easy to output in APA format\n4. The list should automatically add any extra links and stuff that I want (provided those things can be extracted from the `.bib` file).\n\n## R Markdown issues and solutions\n\nR Markdown is generally great for citing things. For example, I could cite a paper [@vuorreSharingOrganizingResearch2021], the citation would appear in the text, and a full citation would be printed in a reference section at the end of the document.\n\nHowever, it's not so easy to print a full citation in the middle of an R Markdown document, in a style that you want defined by `.csl`, and with additional stuff you might want like extra links.\n\nAt least, I couldn't find a way to do that until this morning, when I came across a life-saver function from [stevemisc](http://svmiller.com/stevemisc/) called `print_refs()`.\n\nThere's at least a handful of ways to input a `.bib` file into R, and then print out a single entry. For example, `RefManageR` can do something like this, but it doesn't support `.csl`, so the output may not be in the style you want (and it doesn't output to APA).\n\nHere's a quick example of `print_refs()` in action.\n\n```{r}\nlibrary(bib2df)\nlibrary(stevemisc)\nlibrary(stringi)\n\n# load a bib file to data frame\nbib_df <- bib2df(file=\"Crump.bib\")\n\n# clean entries\nbib_df$TITLE <- stri_replace_all_regex(bib_df$TITLE, \"[\\\\{\\\\}]\", \"\")\nbib_df$JOURNAL <- stri_replace_all_regex(bib_df$JOURNAL, \"[\\\\{\\\\}]\", \"\")\nbib_df$BOOKTITLE <- stri_replace_all_regex(bib_df$BOOKTITLE, \"[\\\\{\\\\}]\", \"\")\n\n# convert a single row back to .bib entry\nbib_entry <- paste0(capture.output(df2bib(bib_df[1,])), collapse=\"\")\nbib_entry\n\n# print out the citation\nstevemisc::print_refs(bib_entry,\n                      csl = \"apa.csl\",\n                      spit_out = TRUE,\n                      delete_after = FALSE)\n```\n\nI'm so glad this function exists. It turns the `.bib` file into markdown that can be printed directly inside an `.Rmd`. And, this can be done programmatically using knitr chunks. For example, using `results=asis` in the `knitr` chunk options allows the citation to printed to the `.Rmd` document.\n\n````{verbatim}\n\n```{r, results=\"asis\", echo=FALSE}\n  print_me <- paste0(stevemisc::print_refs(bib_entry,csl = \"apa.csl\",\n                                        spit_out = FALSE,\n                                        delete_after = FALSE), collapse=\" \")\n  cat(print_me)\n```\n\n````\n\n\nAnd, this means the citation should show up nicely on the webpage, like this:\n\n```{r, results=\"asis\", echo=FALSE}\n  print_me <- paste0(stevemisc::print_refs(bib_entry,csl = \"apa.csl\",\n                                        spit_out = FALSE,\n                                        delete_after = FALSE), collapse=\" \")\n  cat(print_me)\n```\n\n\n## Adding links to the citation\n\nA next step was to add any other links to a given citation. I add extra tags to a `.bib` file in the extra field for citations in zotero. For example, this line is in the extra field for the @vuorreSharingOrganizingResearch2021 paper.\n\n```\ntex.url_website: https://crumplab.github.io/vertical/\n```\n\nAs a result, when the `.bib` file is loaded into R as a data.frame, it will contain a column called `URL_WEBSITE`. I can then retrieve that info and write some custom code to smash together the markdown for a citation, along with any html I want to add it. The script below auto-generates a list of the first five publications in the `.bib` file (after sorting by year, so the most recent are first).\n\n```{r, results=\"asis\"}\n\n# sort bib_df by year\nbib_df <- bib_df[order(bib_df$DATE, decreasing=T),]\n\n# print individual entries to page\n\nfor (i in 1:5 ){\n  t_bib_entry <- paste0(capture.output(df2bib(bib_df[i,])), collapse=\"\")\n  t_md_citation<- paste0(stevemisc::print_refs(t_bib_entry,csl = \"apa.csl\",\n                                        spit_out = FALSE,\n                                        delete_after = FALSE), collapse=\" \")\n  cat(t_md_citation)\n\n\n\n  cat(\"<span class = 'publinks'>\")\n\n  if(any(names(bib_df)==\"FILE\")){\n    if( !is.na(bib_df[i,\"FILE\"]) ){\n      pdf_url <- paste0(\"../Crump/\",bib_df[i,\"FILE\"], collapse = \"\")\n      cat(c(\"  \",'<a href=\"',pdf_url,'\"> <i class=\"fas fa-file-pdf\"> pdf </i></a>'),\n        sep=\"\")\n    }\n  }\n\n  if(any(names(bib_df)==\"URL_WEBSITE\")){\n    if( !is.na(bib_df[i,\"URL_WEBSITE\"]) ){\n      pdf_url <- as.character(bib_df[i,\"URL_WEBSITE\"])\n      cat(c(\"  \",'<a href=\"',pdf_url,'\"> <i class=\"fas fa-globe\"> website </i></a>'),\n        sep=\"\")\n    }\n  }\n\n  if(any(names(bib_df)==\"URL_DATA\")){\n  if( !is.na(bib_df[i,\"URL_DATA\"]) ){\n      pdf_url <- as.character(bib_df[i,\"URL_DATA\"])\n      cat(c(\"  \",'<a href=\"',pdf_url,'\"> <i class=\"fas fa-database\"> data </i></a>'),\n        sep=\"\")\n    }\n  }\n\n  cat(\"</span>\")\n  cat(\"\\n\\n\")\n}\n```\n\nNOTE: the pdf links weren't working...oops, will fix that below.\n\n## That's all\n\nI now have a working pipeline that inputs a `.bib` file, and outputs a list of [publications](https://www.crumplab.com/articles/Publications.html) in APA format, with a few customizable bells and whistles.\n\nI would feel like this excursion was wrapped up if I refactored the script into a set of functions. But, I'll leave that for another day.\n\n<iframe src=\"https://giphy.com/embed/HGX3gYWt9vLZ6\" width=\"480\" height=\"427\" frameBorder=\"0\" class=\"giphy-embed\" allowFullScreen></iframe><p><a href=\"https://giphy.com/gifs/babe-pig-james-cromwell-HGX3gYWt9vLZ6\">via GIPHY</a></p>\n\n## Functionalizing\n\nIdeally I would like to run a single function like this, and have a whole publication list generated, complete with extra links and icons add to each entry.\n\n```{r, eval=FALSE}\nbib_2_pub_list(\"mybib.bib\")\n```\n\nI don't have that solution yet, but may update this post when I have time to make progress in that direction.\n\nIn order for the above to work it be necessary to include any metadata for the links in the .bib file. This could be done using the [extras field in zotero](https://retorque.re/zotero-better-bibtex/exporting/extra-fields/). I'm already using this approach to export urls. I ran into a few roadblocks attempting to generalize this approach. \n\nAlternatively, two inputs might be better. For example, a `.yml` file could be used to define metadata for links.\n\n```{r, eval=FALSE}\nbib_2_pub_list(\"mybib.bib\",\"mybib.yml\")\n```\n\nHmmm, need to brainstorm a `.yml` structure. This should work. A citation key, followed by numbered links, each containing a name, url, and font awesome icon.\n\n```\nvuorreSharingOrganizingResearch2021:\n  link1:\n    name: 'website'\n    url: 'https://www.crumplab.com/vertical'\n    icon: 'fas fa-globe'\n  link2:\n    name: 'github'\n    url: 'https://github.com/CrumpLab/vertical'\n    icon: 'fas fa-github'\n\nbehmerCrunchingBigData2017:\n  link1:\n    name: 'data'\n    url: 'https://github.com/CrumpLab/BehmerCrump2017_BigData'\n    icon: 'fas fa-database'\n```\n\nI can read in the `.yml` like this, which turns everything into a list.\n\n```{r}\nyml_links <- yaml::read_yaml(\"Crump.yml\")\n```\n\nThen, need to write some functions...\n```\n\n```{r, eval=FALSE}\nadd_link_icon <- function(url_path,url_text, icon_class){\n  html <- glue::glue('<a href = \"{url_path}\"> <i class=\"{icon_class}\"> {url_text} </i></a>')\n  cat(\"  \",html, sep=\"\")\n}\n```\n\n```{r, eval=FALSE}\n\nbib_2_pub_list <- function(bib,yml,pdf_dir,base_url_to_pdfs){\n\n  # load bib file to df\n  bib_df <- bib2df::bib2df(bib)\n\n  # clean {{}} from entries\n  # to do: improve this part\n  bib_df$TITLE <- stringi::stri_replace_all_regex(bib_df$TITLE, \"[\\\\{\\\\}]\", \"\")\n  bib_df$JOURNAL <- stringi::stri_replace_all_regex(bib_df$JOURNAL, \"[\\\\{\\\\}]\", \"\")\n  bib_df$BOOKTITLE <- stringi::stri_replace_all_regex(bib_df$BOOKTITLE, \"[\\\\{\\\\}]\", \"\")\n\n  # sort bib_df by year\n  # to do: add sort options\n  bib_df <- bib_df[order(bib_df$DATE, decreasing=T),]\n\n  # read yml with links for bib entries\n  yml_links <- yaml::read_yaml(yml)\n\n  # print entries\n\n  for (i in 1:dim(bib_df)[1] ){\n\n    # convert row to .bib entry\n    # to do: make row to bib entry a function\n    t_bib_entry <- paste0(capture.output(bib2df::df2bib(bib_df[i,])), collapse=\"\")\n    # generate markdown text for citation\n    t_md_citation<- paste0(stevemisc::print_refs(t_bib_entry,csl = \"apa.csl\",\n                                                 spit_out = FALSE,\n                                                 delete_after = FALSE), collapse=\" \")\n    cat(t_md_citation)\n\n    cat(\"<span class = 'publinks'>\")\n\n    ### add pdf links\n    if( !is.na(bib_df$FILE[i]) ) { #check pdf exists\n\n      pdf_name <- basename(bib_df$FILE[i])\n      rel_path_to_pdf <- list.files(here::here(pdf_dir),\n                                    basename(bib_df$FILE[i]),\n                                    recursive=T)\n      build_url <- paste0(base_url_to_pdfs,\"/\",rel_path_to_pdf,collapse=\"\")\n      crumplab::add_link_icon(build_url,\"pdf\",\"fas fa-file-pdf\")\n\n    }\n\n    ## add all other links\n    if( exists(bib_df$BIBTEXKEY[i],yml_links) ) { # check yml bib entry exists\n\n      link_list <- yml_links[[bib_df$BIBTEXKEY[i]]]\n\n      for(l in link_list){\n        crumplab::add_link_icon(l$url,l$name,l$icon)\n      }\n\n    }\n    cat(\"</span>\")\n    cat(\"\\n\\n\")\n  }\n\n}\n\n\n```\n\nDoes it blend?\n\n```{r, results='asis', message=F, warning=FALSE, eval=TRUE}\ncrumplab::bib_2_pub_list(\"Crump.bib\",\n                         \"Crump.yml\",\n                         \"pkgdown/assets/Crump/files\",\n                         \"https://www.crumplab.com/Crump/files\")\n```\n\n<iframe src=\"https://giphy.com/embed/i29DtU2PMkzsI\" width=\"480\" height=\"458\" frameBorder=\"0\" class=\"giphy-embed\" allowFullScreen></iframe><p><a href=\"https://giphy.com/gifs/live-presents-dsd-i29DtU2PMkzsI\">via GIPHY</a></p>\n\nThat works pretty well.\n\nNext step is to include this function in my `crumplab` package that is part of this webpage, and make it work for real.\n\n\n\n## References\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"index.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.210","editor":"visual","theme":"minty","title":"Customizing a publication list with R Markdown","description":"Notes on creating a customizable list of publications for an academic website using R markdown, .bib files, and other fun stuff.","author":"Matt Crump","date":"2022-05-17","bibliography":["Crump.bib"],"image":"imgs/publications_list.jpg","opengraph":{"image":{"src":"https://www.crumplab.com/articles/blog/post_997_5_19_22_pubs/imgs/publications_list.jpg"},"twitter":{"card":"summary_large_image","creator":"@MattCrumpLab","site":"@MattCrumpLab"}}},"extensions":{"book":{"multiFile":true}}}}}